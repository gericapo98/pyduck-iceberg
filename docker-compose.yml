version: "3.9"

services:
  minio:
    image: minio/minio:latest
    command: server --console-address ":9001" /data
    ports: ["9000:9000", "9001:9001"]
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - minio-data:/data

  nessie:
    image: ghcr.io/projectnessie/nessie:latest
    ports: ["19120:19120"]
    environment:
      QUARKUS_HTTP_PORT: 19120
      NESSIE_CATALOG_DEFAULT_WAREHOUSE: local
      NESSIE_CATALOG_WAREHOUSES__local__LOCATION: s3://lake/warehouse
      NESSIE_CATALOG_WAREHOUSES__local__S3__ENDPOINT: http://minio:9000
      NESSIE_CATALOG_WAREHOUSES__local__S3__REGION: us-east-1
      NESSIE_CATALOG_WAREHOUSES__local__S3__ACCESS_KEY_ID: minioadmin
      NESSIE_CATALOG_WAREHOUSES__local__S3__SECRET_ACCESS_KEY: minioadmin
      NESSIE_CATALOG_WAREHOUSES__local__S3__PATH_STYLE_ACCESS: "true"
      NESSIE_CATALOG_WAREHOUSES__local__S3__SSL_ENABLED: "false"
    depends_on:
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:19120/iceberg/v1/config?warehouse=local"]
      interval: 5s
      timeout: 3s
      retries: 20

  mc:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command: |
      set -e
      mc alias set local http://minio:9000 minioadmin minioadmin
      until mc admin info local >/dev/null 2>&1; do sleep 1; done
      mc mb -p local/lake || true
      # ensure warehouse prefix exists
      echo ok | mc pipe local/lake/warehouse/.keep || true

volumes:
  minio-data:

